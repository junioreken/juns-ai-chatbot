<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JUNâ€™S AI Chat</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0; padding: 0;
      background: #f5f5f5;
    }

    #chat {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      height: 90vh;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px;
      display: flex;
      flex-direction: column;
    }

    .msg {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 20px;
      margin: 6px 0;
      font-size: 15px;
      line-height: 1.5;
    }

    .ai {
      background-color: #e5e5ea;
      color: black;
      align-self: flex-start;
    }

    .user {
      background-color: #007aff;
      color: white;
      align-self: flex-end;
    }

    #typing {
      font-style: italic;
      font-size: 14px;
      color: grey;
      margin-bottom: 8px;
      display: none;
    }

    #suggestions button {
      background: #e1e1e1;
      border: none;
      border-radius: 16px;
      padding: 6px 12px;
      margin: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    #input-area {
      display: flex;
      gap: 8px;
    }

    input, button {
      padding: 10px;
      font-size: 15px;
    }

    @media (max-width: 600px) {
      #chat {
        padding: 10px;
      }
      .msg {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div id="chat">
    <div id="messages"></div>
    <div id="typing">JUNâ€™S AI is typing...</div>
    <div id="suggestions"></div>
    <div id="input-area">
      <input id="userInput" placeholder="Type your message..." />
      <button onclick="send()">Send</button>
    </div>
  </div>

  <script>
    let lang = '';
    let name = '';
    let email = '';
    let initialized = false;

    const messages = document.getElementById("messages");
    const input = document.getElementById("userInput");
    const typing = document.getElementById("typing");

    const popularSuggestions = [
      "Do you want a dress recommendation?",
      "Where is my order?",
      "Do you offer returns?",
      "Which size should I choose?",
    ];

    function addMessage(content, sender) {
      const msg = document.createElement("div");
      msg.className = "msg " + sender;
      msg.innerText = content;
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    function setSuggestions() {
      const container = document.getElementById("suggestions");
      container.innerHTML = '';
      popularSuggestions.forEach(text => {
        const btn = document.createElement("button");
        btn.textContent = text;
        btn.onclick = () => {
          input.value = text;
          send();
        };
        container.appendChild(btn);
      });
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, 'user');
      input.value = '';
      typing.style.display = 'block';

      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, lang, name, email })
      });

      const data = await res.json();
      typing.style.display = 'none';
      addMessage(data.reply, 'ai');
    }

    function askInitialQuestions() {
      const langPrompt = "Please choose your language:\n1. English\n2. FranÃ§ais";
      addMessage(langPrompt, 'ai');
      const check = setInterval(() => {
        if (lang) {
          clearInterval(check);
          const namePrompt = lang === 'fr' ? "Quel est votre prÃ©nom ?" : "What is your name?";
          addMessage(namePrompt, 'ai');
        }
      }, 500);
    }

    input.addEventListener("keydown", function(e) {
      if (e.key === "Enter") send();
    });

    // Capture user responses
    const responseQueue = [];

    const observer = new MutationObserver(() => {
      if (initialized) return;
      initialized = true;

      const checkLang = setInterval(() => {
        const lastMsg = messages.lastChild?.textContent?.toLowerCase();
        if (!lang && lastMsg) {
          if (lastMsg.includes('1') || lastMsg.includes('english')) lang = 'en';
          if (lastMsg.includes('2') || lastMsg.includes('franÃ§ais') || lastMsg.includes('francais')) lang = 'fr';
        }
        if (lang) {
          clearInterval(checkLang);
          const nameMsg = lang === 'fr' ? "Quel est votre prÃ©nom ?" : "What is your name?";
          addMessage(nameMsg, 'ai');

          const checkName = setInterval(() => {
            const latest = messages.lastChild?.textContent;
            if (!name && latest && latest !== nameMsg) {
              name = latest;
              clearInterval(checkName);
              const emailMsg = lang === 'fr' ? "Quelle est votre adresse e-mail ?" : "Whatâ€™s your email address?";
              addMessage(emailMsg, 'ai');

              const checkEmail = setInterval(() => {
                const e = messages.lastChild?.textContent;
                if (!email && e && e !== emailMsg) {
                  email = e;
                  clearInterval(checkEmail);
                  const welcome = lang === 'fr'
                    ? `Bonjour ${name} ðŸ‘‹ Je suis JUNâ€™S AI. Posez-moi vos questions ou demandez une recommandation !`
                    : `Hi ${name} ðŸ‘‹ I'm JUNâ€™S AI. Ask me anything or get a dress recommendation!`;
                  addMessage(welcome, 'ai');
                  setSuggestions();
                }
              }, 1000);
            }
          }, 1000);
        }
      }, 1000);
    });

    observer.observe(messages, { childList: true });

    // Start the convo
    window.onload = () => {
      askInitialQuestions();
    };
  </script>
</body>
</html>
